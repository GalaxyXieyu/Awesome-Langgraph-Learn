# 优雅方案：自动提取中间结果 🚀

## 问题回顾

**原方案的问题**：
- ❌ 需要手动构建中间结果
- ❌ 每个 LLM 节点都要适配
- ❌ 每个新 graph 都要重新配置

## 新方案：零侵入自动提取 ✨

### 核心思路

LangSmith 已经自动记录了所有运行的完整 Trace，包括：
- 每个 LLM 调用的输入
- 每个 LLM 调用的输出
- 完整的执行链路

**我们只需要从 Trace 中自动提取这些数据！**

---

## 使用方法（3步，2分钟）

### 第1步：运行一次你的 Graph（已有）

```bash
# 你已经在做的事情
python main.py --query "人工智能行业分析"
```

这会自动记录到 LangSmith（如果配置了 `LANGSMITH_API_KEY`）

### 第2步：自动提取中间结果

```bash
python tools/auto_extract_from_trace.py
```

**交互式界面**：
```
找到 10 条运行记录:

1. Run ID: abc123...
   名称: ReportGraph
   时间: 2024-10-25 14:30:00
   查询: 人工智能行业分析...
   状态: success
------------------------------------------------------------

请选择操作:
1. 保存某次运行的 LLM 输入
2. 从多次运行创建 LangSmith Dataset
3. 退出

选择 (1/2/3): 2

选择运行编号（多个用逗号分隔，如 1,2,3）: 1,2,3

Dataset 名称（留空使用默认）: my_test_inputs

只提取特定节点？（留空=全部，如 'report_generator'）: 

[开始] 创建 Dataset: my_test_inputs
============================================================
处理 Run: abc123...
  [OK] 找到 LLM 调用: parse_parameters_node
  [OK] 找到 LLM 调用: generate_report_node
  [OK] 添加示例: parse_parameters_node
  [OK] 添加示例: generate_report_node

[完成] Dataset 创建完成!
  - 数据集名称: my_test_inputs
  - 总示例数: 6
  - 查看: https://smith.langchain.com/datasets

使用方法:
  1. 访问 LangSmith Playground
  2. 选择你的提示词
  3. 点击 'Select Dataset' → 'my_test_inputs'
  4. 切换提示词，输入会自动填充 ✅
```

### 第3步：在 Playground 中使用

1. 访问 https://smith.langchain.com/
2. 进入 **Prompts** → 选择 `report_generator`
3. 点击 **Open in Playground**
4. 点击 **Select Dataset** → 选择 `my_test_inputs`
5. 现在可以：
   - ✅ 切换不同的提示词版本
   - ✅ 切换不同的测试用例
   - ✅ **输入自动填充，不会丢失**

---

## 优势对比

| 特性 | 手动方案 | 自动提取方案 |
|-----|---------|------------|
| 构建中间结果 | ❌ 手动编写代码 | ✅ 自动从 Trace 提取 |
| 代码侵入性 | ❌ 需要修改 nodes.py | ✅ 零侵入 |
| 适配新 Graph | ❌ 每个都要适配 | ✅ 通用，无需适配 |
| 提取所有节点 | ❌ 手动指定 | ✅ 自动提取全部 |
| 更新场景 | ❌ 手动修改代码 | ✅ 重新运行即可 |

---

## 工作流

### 日常开发：调试提示词

```bash
# 1. 运行一次（测试新功能）
python main.py --query "区块链技术发展"

# 2. 自动提取中间结果
python tools/auto_extract_from_trace.py
# → 选择选项 2
# → 选择最近的几次运行
# → 创建 Dataset

# 3. 在 Playground 中测试不同提示词
# → 访问 LangSmith Playground
# → 选择 Dataset
# → 切换提示词版本
# → 输入自动填充 ✅
```

### 团队协作：共享测试数据

```bash
# 开发者 A：跑几个典型场景
python main.py --query "AI 行业报告"
python main.py --query "金融科技分析"
python main.py --query "新能源汽车研究"

# 创建共享 Dataset
python tools/auto_extract_from_trace.py
# → 选择这 3 次运行
# → Dataset 名称: "team_test_cases"

# 开发者 B、C、D：直接使用
# → 在 Playground 选择 "team_test_cases"
# → 立即开始调试 ✅
```

---

## 高级用法

### 1. 只提取特定节点的输入

```bash
python tools/auto_extract_from_trace.py

# 选择选项 2
# 只提取特定节点：report_generator

# 结果：Dataset 中只包含 report_generator 节点的输入
```

### 2. 编程式使用

```python
from tools.auto_extract_from_trace import TraceExtractor

extractor = TraceExtractor()

# 方式1：交互式
extractor.interactive_mode()

# 方式2：编程式
runs = extractor.list_recent_runs(limit=5)
run_id = str(runs[0].id)

# 保存中间结果
data = extractor.save_llm_inputs(run_id, scenario_name="my_test")

# 创建 Dataset
extractor.create_dataset_from_runs(
    run_ids=[run_id],
    dataset_name="auto_test_inputs",
    llm_node_filter="report_generator"  # 可选：只提取特定节点
)
```

### 3. CI/CD 集成

```yaml
# .github/workflows/create_test_dataset.yml
name: Create Test Dataset

on:
  workflow_dispatch:  # 手动触发

jobs:
  create-dataset:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Run test scenarios
        env:
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          # 运行几个典型场景
          python main.py --query "AI 行业报告"
          python main.py --query "金融科技分析"
          python main.py --query "新能源研究"
      
      - name: Extract and create dataset
        run: |
          python -c "
          from tools.auto_extract_from_trace import TraceExtractor
          extractor = TraceExtractor()
          runs = extractor.list_recent_runs(limit=3)
          run_ids = [str(r.id) for r in runs]
          extractor.create_dataset_from_runs(run_ids, 'ci_test_dataset')
          "
```

---

## 与方案1对比

### 方案1（手动）：`.middle_results_cache/`

**优势**：
- ✅ 本地测试（无需联网）
- ✅ 完全控制数据格式

**劣势**：
- ❌ 需要手动编写保存代码
- ❌ 需要适配每个 Graph
- ❌ 更新场景需要修改代码

### 方案2（自动）：从 Trace 提取

**优势**：
- ✅ 零代码侵入
- ✅ 通用，适用任何 Graph
- ✅ 自动提取所有节点
- ✅ 更新场景只需重新运行

**劣势**：
- ⚠️ 需要配置 LANGSMITH_API_KEY
- ⚠️ 需要联网（但 Playground 本身就需要）

---

## 推荐使用场景

| 场景 | 推荐方案 | 原因 |
|-----|---------|------|
| **多个 Graph 项目** | 方案2（自动提取）| 通用，无需每个都适配 |
| **团队协作** | 方案2（自动提取）| 自动共享到 LangSmith |
| **快速原型开发** | 方案2（自动提取）| 零配置，开箱即用 |
| **离线开发** | 方案1（手动）| 不需要联网 |
| **高度定制场景** | 方案1（手动）| 完全控制数据格式 |

**建议**：优先使用方案2，特殊情况用方案1

---

## 常见问题

### Q1: 需要修改现有代码吗？

**A**: 不需要！只要你的项目配置了 LangSmith（设置了 `LANGSMITH_API_KEY`），就会自动记录 Trace，然后运行提取工具即可。

### Q2: 适用于所有 LangGraph 项目吗？

**A**: 是的！这个工具会自动检测所有 LLM 调用（`run_type` 为 `llm` 或 `chat_model`），无论你的 Graph 结构如何。

### Q3: 如何添加新的测试场景？

**A**: 
```bash
# 1. 运行新场景
python main.py --query "新的测试场景"

# 2. 重新提取
python tools/auto_extract_from_trace.py
# → 选择最新的运行记录
```

### Q4: 能否只提取某个特定节点？

**A**: 可以！在创建 Dataset 时指定 `llm_node_filter`：
```python
extractor.create_dataset_from_runs(
    run_ids=[...],
    llm_node_filter="report_generator"  # 只提取这个节点
)
```

### Q5: 与手动方案可以共存吗？

**A**: 可以！两种方案互不冲突：
- 方案1：本地快速测试
- 方案2：团队共享、Playground 使用

---

## 总结

### 核心价值

**从 "手动适配每个 Graph"**  
**到 "通用自动提取，零代码侵入"**

### 使用流程

```
运行 Graph（已有）
    ↓
自动提取（2分钟）
    ↓
Playground 使用（输入自动填充）✅
```

### 下一步

1. ✅ 运行一次你的 Graph
2. 运行 `python tools/auto_extract_from_trace.py`
3. 在 Playground 中选择创建的 Dataset
4. 开始调试，切换提示词，输入自动填充 🎉

---

## 文件位置

- **工具脚本**：`tools/auto_extract_from_trace.py`
- **缓存目录**：`.trace_cache/`（自动创建）
- **使用文档**：`优雅方案-自动提取.md`（本文档）

完整方案对比请查看：`docs/多LLM流程调试方案.md`

