# å¿«é€Ÿå¼€å§‹ï¼šå¤š LLM æµç¨‹æç¤ºè¯è°ƒè¯•

## é—®é¢˜
åœ¨ä½ çš„æµç¨‹ä¸­ï¼Œ`generate_report_node` çš„è¾“å…¥æ¥è‡ªä¸Šæ¸¸ LLM çš„è¾“å‡ºã€‚æƒ³åœ¨ Playground è°ƒè¯•æ—¶åˆ‡æ¢ä¸åŒæç¤ºè¯ï¼Œä½†æ¯æ¬¡éƒ½è¦é‡æ–°è¾“å…¥å‚æ•°ã€‚

## è§£å†³æ–¹æ¡ˆï¼ˆ3åˆ†é’Ÿä¸Šæ‰‹ï¼‰

### ç¬¬ä¸€æ­¥ï¼šä¿å­˜ä¸­é—´ç»“æœï¼ˆå·²å®Œæˆâœ…ï¼‰

```bash
python tools/middle_result_dataset.py
```

**ç»“æœ**ï¼šå·²åˆ›å»º 3 ä¸ªæµ‹è¯•åœºæ™¯ï¼Œä¿å­˜åœ¨ `.middle_results_cache/`

æŸ¥çœ‹åœºæ™¯ï¼š
```bash
ls .middle_results_cache/
# ai_formal_deep.json
# fintech_concise_shallow.json
# new_energy_detailed_medium.json
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæç¤ºè¯çš„å¤šä¸ªç‰ˆæœ¬

```bash
# å¤åˆ¶ç°æœ‰æç¤ºè¯
cp prompts/report_generator.yaml prompts/report_generator_v2.yaml

# ä¿®æ”¹ v2 ç‰ˆæœ¬ï¼ˆæ¯”å¦‚æ”¹è¿› system messageï¼‰
```

### ç¬¬ä¸‰æ­¥ï¼šæ‰¹é‡å¯¹æ¯”æµ‹è¯•

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_prompts.py`ï¼š

```python
from tools.prompt_comparison_test import PromptComparisonTest

tester = PromptComparisonTest()

# ç”¨ç›¸åŒçš„è¾“å…¥æµ‹è¯•ä¸¤ä¸ªç‰ˆæœ¬
results = tester.compare_prompts(
    prompt_files=[
        "report_generator.yaml",      # åŸå§‹ç‰ˆæœ¬
        "report_generator_v2.yaml"    # ä¿®æ”¹åçš„ç‰ˆæœ¬
    ],
    scenario_name="ai_formal_deep",   # ä½¿ç”¨ä¿å­˜çš„åœºæ™¯
    save_results=True
)
```

è¿è¡Œï¼š
```bash
python test_prompts.py
```

### ç¬¬å››æ­¥ï¼šæŸ¥çœ‹å¯¹æ¯”ç»“æœ

```bash
# æŸ¥çœ‹ç»Ÿè®¡æ‘˜è¦
cat comparison_results/comparison_*.json

# å¯¹æ¯”å®Œæ•´è¾“å‡º
# Windows PowerShell:
diff (cat comparison_results/ai_formal_deep_report_generator_*.md)

# æˆ–è€…ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å¯¹æ¯”
code comparison_results/
```

---

## æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ“ä½œæ–¹å¼ | ä¼˜åŠ¿ | é€‚ç”¨åœºæ™¯ |
|-----|---------|------|---------|
| **æ–¹æ¡ˆ1ï¼šæœ¬åœ°æ‰¹é‡æµ‹è¯•** | è¿è¡Œ Python è„šæœ¬ | â€¢ é›¶æ‰‹åŠ¨è¾“å…¥<br>â€¢ æ‰¹é‡å¯¹æ¯”<br>â€¢ é€Ÿåº¦å¿« | **æ—¥å¸¸å¼€å‘ï¼ˆæ¨èï¼‰** |
| æ–¹æ¡ˆ2ï¼šLangSmith Dataset | Playground é€‰æ‹© Dataset | â€¢ å¯è§†åŒ–<br>â€¢ å›¢é˜Ÿå…±äº« | å›¢é˜Ÿåä½œ |
| æ–¹æ¡ˆ3ï¼šä» Trace å¯¼å‡º | ä» Trace æ‰“å¼€ | â€¢ å¿«é€Ÿå¯åŠ¨<br>âš ï¸ åˆ‡æ¢æç¤ºè¯ä¼šä¸¢å¤±è¾“å…¥ | ä¸´æ—¶è°ƒè¯• |

---

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šä¼˜åŒ–æŠ¥å‘Šçš„è¯­è¨€é£æ ¼

```bash
# 1. åˆ›å»ºæ–°ç‰ˆæœ¬
cp prompts/report_generator.yaml prompts/report_generator_casual.yaml

# 2. ä¿®æ”¹ system messageï¼Œè®©è¯­è¨€æ›´é€šä¿—æ˜“æ‡‚
# ç¼–è¾‘ report_generator_casual.yaml

# 3. æ‰¹é‡æµ‹è¯• 3 ä¸ªåœºæ™¯
python -c "
from tools.prompt_comparison_test import PromptComparisonTest

tester = PromptComparisonTest()

for scenario in ['ai_formal_deep', 'fintech_concise_shallow', 'new_energy_detailed_medium']:
    print(f'\næµ‹è¯•åœºæ™¯: {scenario}')
    tester.compare_prompts(
        ['report_generator.yaml', 'report_generator_casual.yaml'],
        scenario,
        save_results=True
    )
"

# 4. æŸ¥çœ‹ç»“æœ
ls comparison_results/
```

---

## é«˜çº§åŠŸèƒ½

### 1. ä»å®é™…è¿è¡Œä¸­ä¿å­˜ä¸­é—´ç»“æœ

ä¿®æ”¹ `graph/nodes.py`ï¼Œåœ¨ `web_search_node` æœ«å°¾æ·»åŠ ï¼š

```python
# è°ƒè¯•æ¨¡å¼ï¼šä¿å­˜ä¸­é—´ç»“æœ
if os.getenv("SAVE_MIDDLE_RESULT") == "true":
    from tools.middle_result_dataset import MiddleResultDataset
    debug = MiddleResultDataset()
    debug.save_middle_result_manually(
        topic=state.get("topic"),
        year_range=state.get("year_range"),
        style=state.get("style"),
        depth=state.get("depth"),
        focus_areas=state.get("focus_areas"),
        search_results=state.get("search_results_formatted"),
        scenario_name=state.get("topic", "default").replace(" ", "_")
    )
```

ä½¿ç”¨ï¼š
```bash
SAVE_MIDDLE_RESULT=true python main.py --query "åŒºå—é“¾æŠ€æœ¯å‘å±•"
```

### 2. åˆ›å»º LangSmith Datasetï¼ˆå¯é€‰ï¼‰

å¦‚æœé…ç½®äº† `LANGSMITH_API_KEY`ï¼š

```python
from tools.middle_result_dataset import MiddleResultDataset

manager = MiddleResultDataset()
manager.create_langsmith_dataset("report_generator_middle_results")
```

ç„¶ååœ¨ LangSmith Playground ä¸­ï¼š
1. é€‰æ‹© `report_generator` æç¤ºè¯
2. ç‚¹å‡» "Select Dataset" â†’ é€‰æ‹© `report_generator_middle_results`
3. åˆ‡æ¢æç¤ºè¯ç‰ˆæœ¬ï¼Œè¾“å…¥ä¼šè‡ªåŠ¨å¡«å…… âœ…

---

## å·¥ä½œæµå»ºè®®

### æ—¥å¸¸å¼€å‘è¿­ä»£

```
1. ä¿®æ”¹æç¤ºè¯
   â†“
2. è¿è¡Œæœ¬åœ°æ‰¹é‡æµ‹è¯•ï¼ˆ3ä¸ªåœºæ™¯ï¼Œ2åˆ†é’Ÿï¼‰
   â†“
3. æŸ¥çœ‹å¯¹æ¯”ç»“æœ
   â†“
4. ç»§ç»­è¿­ä»£æˆ–æ¨é€åˆ° Hub
```

### ç‰ˆæœ¬ç®¡ç†

```
prompts/
  â”œâ”€â”€ report_generator.yaml          # å½“å‰ç‰ˆæœ¬ï¼ˆç”Ÿäº§ï¼‰
  â”œâ”€â”€ report_generator_v2.yaml       # å®éªŒç‰ˆæœ¬1
  â””â”€â”€ report_generator_casual.yaml   # å®éªŒç‰ˆæœ¬2ï¼ˆé€šä¿—é£æ ¼ï¼‰

# æµ‹è¯•åé€‰æ‹©æœ€ä¼˜ç‰ˆæœ¬
mv report_generator_v2.yaml report_generator.yaml
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„æµ‹è¯•åœºæ™¯ï¼Ÿ

**æ–¹æ³•1**ï¼šç¼–è¾‘ `tools/middle_result_dataset.py`ï¼Œæ·»åŠ æ–°çš„ `save_middle_result_manually` è°ƒç”¨

**æ–¹æ³•2**ï¼šä»å®é™…è¿è¡Œä¸­ä¿å­˜ï¼ˆè§é«˜çº§åŠŸèƒ½ï¼‰

### Q2: å¯¹æ¯”ç»“æœä¿å­˜åœ¨å“ªé‡Œï¼Ÿ

- **ç»Ÿè®¡æ‘˜è¦**ï¼š`comparison_results/comparison_*.json`
- **å®Œæ•´è¾“å‡º**ï¼š`comparison_results/<scenario>_<prompt>_*.md`

### Q3: å¦‚ä½•åªæµ‹è¯•ç‰¹å®šåœºæ™¯ï¼Ÿ

```python
# åªæµ‹è¯•ä¸€ä¸ªåœºæ™¯
tester.compare_prompts(
    ['report_generator.yaml', 'report_generator_v2.yaml'],
    scenario_name="ai_formal_deep"  # æŒ‡å®šåœºæ™¯
)
```

---

## æ–‡ä»¶æ¸…å•

- âœ… `tools/middle_result_dataset.py` - ä¸­é—´ç»“æœç®¡ç†å·¥å…·
- âœ… `tools/prompt_comparison_test.py` - æç¤ºè¯å¯¹æ¯”æµ‹è¯•å·¥å…·
- âœ… `.middle_results_cache/` - ä¸­é—´ç»“æœç¼“å­˜ï¼ˆå·²åˆ›å»º3ä¸ªåœºæ™¯ï¼‰
- âœ… `comparison_results/` - å¯¹æ¯”æµ‹è¯•ç»“æœï¼ˆè¿è¡Œæµ‹è¯•åç”Ÿæˆï¼‰
- âœ… `docs/å¤šLLMæµç¨‹è°ƒè¯•æ–¹æ¡ˆ.md` - å®Œæ•´æ–¹æ¡ˆæ–‡æ¡£

---

## æ€»ç»“

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **å›ºåŒ–è¾“å…¥**ï¼šä¸­é—´ç»“æœä¿å­˜ä¸ºåœºæ™¯ï¼Œæ— éœ€é‡å¤è¾“å…¥
- âš¡ **å¿«é€Ÿå¯¹æ¯”**ï¼šä¸€æ¬¡è¿è¡Œæµ‹è¯•å¤šä¸ªæç¤ºè¯ç‰ˆæœ¬
- ğŸ“Š **ç»“æœè¿½æº¯**ï¼šè‡ªåŠ¨ä¿å­˜æ¯æ¬¡æµ‹è¯•çš„å®Œæ•´è¾“å‡º
- ğŸ”„ **å¿«é€Ÿè¿­ä»£**ï¼šä¿®æ”¹ â†’ æµ‹è¯• â†’ å¯¹æ¯”ï¼Œå¾ªç¯å¾€å¤

**ä¸‹ä¸€æ­¥**ï¼š
1. âœ… å·²åˆ›å»º 3 ä¸ªæµ‹è¯•åœºæ™¯
2. åˆ›å»º `report_generator_v2.yaml`ï¼ˆä¿®æ”¹æç¤ºè¯ï¼‰
3. è¿è¡Œ `compare_prompts` å¯¹æ¯”æ•ˆæœ
4. é€‰æ‹©æœ€ä¼˜ç‰ˆæœ¬ï¼Œç»§ç»­è¿­ä»£

æœ‰é—®é¢˜æŸ¥çœ‹ï¼š`docs/å¤šLLMæµç¨‹è°ƒè¯•æ–¹æ¡ˆ.md`

