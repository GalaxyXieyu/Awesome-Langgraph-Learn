<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph å†™ä½œåŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--light-color); color: var(--dark-color); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn { display: inline-block; padding: 12px 24px; border: none; border-radius: 4px; color: #fff; background-color: var(--primary-color); font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; text-align: center; margin-top: 20px; }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; }
        
        /* æ—¥å¿—å’Œç»“æœåŒºåŸŸæ ·å¼ */
        .output-container { margin-top: 30px; }
        .log-stream { 
            background: #222; 
            color: #eee; 
            padding: 15px; 
            border-radius: 4px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: "Courier New", Courier, monospace; 
            font-size: 14px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }
        .result { 
            background: #fdfdfd; 
            border: 1px solid #eee; 
            padding: 15px; 
            border-radius: 4px; 
            margin-top: 20px; 
            min-height: 200px; 
            white-space: pre-wrap; 
            font-size: 16px; 
        }
        .log-entry { 
            padding: 4px 0; 
            border-bottom: 1px solid #444; 
        }
        .log-entry.event-article_chunk { display: none; }
        
        /* ä¸­æ–­å¼¹çª—æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-confirm {
            background: var(--success-color);
            color: white;
        }
        .btn-cancel {
            background: var(--danger-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LangGraph å†™ä½œåŠ©æ‰‹</h1>

        <form id="task-form">
            <h2>å†™ä½œä»»åŠ¡é…ç½®</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="topic">æ–‡ç« ä¸»é¢˜</label>
                    <textarea id="topic" name="topic" required>æ’°å†™ä¸€ç¯‡å…³äº"åœ¨å¤§å‹è¯­è¨€æ¨¡å‹(LLM)é©±åŠ¨çš„åº”ç”¨ç¨‹åºä¸­ï¼ŒLangGraphä¸ä¼ ç»Ÿæµç¨‹ç¼–æ’å·¥å…·(å¦‚Airflow)çš„æ¯”è¾ƒ"çš„æ·±åº¦åˆ†ææ–‡ç« ã€‚</textarea>
                </div>
                <div class="form-group">
                    <label for="max_words">æœ€å¤§å­—æ•°</label>
                    <input type="number" id="max_words" name="max_words" value="1500" required>
                </div>
                <div class="form-group">
                    <label for="style">å†™ä½œé£æ ¼</label>
                    <select id="style" name="style">
                        <option value="professional" selected>ä¸“ä¸š</option>
                        <option value="academic">å­¦æœ¯</option>
                        <option value="technical">æŠ€æœ¯</option>
                        <option value="casual">ä¼‘é—²</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="language">è¯­è¨€</label>
                    <select id="language" name="language">
                        <option value="zh" selected>ä¸­æ–‡</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            <button type="submit" id="start-btn" class="btn btn-success">å¼€å§‹åˆ›ä½œ</button>
        </form>

        <div class="output-container">
            <h2>å®æ—¶è¿‡ç¨‹æµ</h2>
            <div id="log-stream" class="log-stream"></div>
            <h2>æœ€ç»ˆç»“æœ</h2>
            <div id="result" class="result"></div>
        </div>
    </div>

    <!-- ä¸­æ–­ç¡®è®¤å¼¹çª— -->
    <div id="interrupt-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">éœ€è¦æ‚¨çš„å†³ç­–</h3>
            <div id="modal-message-container">
                <p id="modal-message">ä»»åŠ¡å·²æš‚åœï¼Œè¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ</p>
                <p id="modal-instructions" class="modal-instructions"></p>
            </div>
            <div class="modal-buttons">
                <button id="resume-btn" class="modal-btn btn-confirm">æ˜¯ (Yes)</button>
                <button id="cancel-btn" class="modal-btn btn-cancel">å¦ (No)</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = "http://127.0.0.1:8000";
        const form = document.getElementById('task-form');
        const logStream = document.getElementById('log-stream');
        const resultDiv = document.getElementById('result');
        const modal = document.getElementById('interrupt-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInstructions = document.getElementById('modal-instructions');
        const resumeBtn = document.getElementById('resume-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        
        let currentTaskId = null;
        let eventSource = null;

        // æ·»åŠ æ—¥å¿—æ¡ç›®çš„å‡½æ•°
        function addLog(message, type, data = null) {
            const entry = document.createElement('div');
            entry.className = `log-entry event-${type}`;
            
            let displayMessage = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            // å¦‚æœæœ‰è¯¦ç»†æ•°æ®ï¼Œæ·»åŠ æ ¼å¼åŒ–çš„JSON
            if (data) {
                displayMessage += '\n' + JSON.stringify(data, null, 2);
            }
            
            entry.textContent = displayMessage;
            logStream.appendChild(entry);
            logStream.scrollTop = logStream.scrollHeight;
        }

        // æ˜¾ç¤ºä¸­æ–­å¼¹çª—
        function showInterruptModal(title, message, instructions) {
            modalTitle.textContent = title || "éœ€è¦æ‚¨çš„å†³ç­–";
            modalMessage.textContent = message || "ä»»åŠ¡å·²æš‚åœï¼Œè¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ";

            // æ˜¾ç¤ºæŒ‡ä»¤ä¿¡æ¯
            if (instructions && instructions !== message) {
                modalInstructions.textContent = instructions;
                modalInstructions.style.display = 'block';
            } else {
                modalInstructions.style.display = 'none';
            }

            modal.style.display = 'flex';

            return new Promise((resolve, reject) => {
                resumeBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve("yes");
                };
                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve("no");
                };
            });
        }

        // ç›‘å¬äº‹ä»¶æµ
        function listenToEvents(taskId) {
            currentTaskId = taskId;
            eventSource = new EventSource(`${API_BASE_URL}/api/v1/events/${taskId}`);

            eventSource.onopen = () => addLog('å·²è¿æ¥åˆ°äº‹ä»¶æµ', 'connected');

            eventSource.onmessage = async (event) => {
                const eventData = JSON.parse(event.data);
                if (!eventData.data || !eventData.data.type) return;

                const innerData = eventData.data;
                const type = innerData.type;

                switch (type) {
                    case 'custom_event':
                        // å¤„ç†è‡ªå®šä¹‰äº‹ä»¶ - è¿™æ˜¯ä¸»è¦çš„æµå¼å†…å®¹æ›´æ–°
                        const step = innerData.step || 'unknown';
                        const status = innerData.status || '';
                        const progress = innerData.progress || 0;

                        addLog(`[${step}] ${status} (${progress}%)`, type);

                        // å¦‚æœæœ‰å†…å®¹æ‘˜è¦ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                        if (innerData.content_summary) {
                            const summary = innerData.content_summary;
                            if (summary.title) {
                                addLog(`ğŸ“‹ æ ‡é¢˜: ${summary.title}`, 'info');
                            }
                            if (summary.sections_count > 0) {
                                addLog(`ğŸ“‹ ç« èŠ‚æ•°: ${summary.sections_count}`, 'info');
                                if (summary.section_titles && summary.section_titles.length > 0) {
                                    addLog(`ğŸ“‹ ç« èŠ‚: ${summary.section_titles.join(', ')}`, 'info');
                                }
                            }
                        }
                        break;

                    case 'progress_update':
                        addLog(`[èŠ‚ç‚¹] ${innerData.step}`, type, innerData.content_info);
                        break;

                    case 'progress_detail':
                        const detailData = innerData.data || {};
                        addLog(
                            `[è¿›åº¦] ${detailData.step} - ${detailData.status} (${detailData.progress || 0}%)`,
                            type,
                            detailData.current_content
                        );
                        break;
                    
                    case 'article_chunk':
                        resultDiv.textContent += innerData.token;
                        break;
                    
                    case 'interrupt_request':
                        // æ ¹æ®ä¸­æ–­ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ—¥å¿—ä¿¡æ¯
                        const interruptType = innerData.interrupt_type || 'confirmation';
                        const interruptTitle = innerData.title || innerData.interrupt_type || "éœ€è¦æ‚¨çš„å†³ç­–";

                        addLog(`[ä¸­æ–­] ${interruptType} - ç­‰å¾…ç”¨æˆ·ç¡®è®¤...`, type);

                        // æ˜¾ç¤ºè¯¦ç»†çš„ä¸­æ–­ä¿¡æ¯
                        if (innerData.instructions) {
                            addLog(`[è¯´æ˜] ${innerData.instructions}`, 'info');
                        }

                        const shouldResume = await showInterruptModal(
                            interruptTitle,
                            innerData.message || "ä»»åŠ¡å·²æš‚åœï¼Œè¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ",
                            innerData.instructions || "è¯·é€‰æ‹©æ‚¨çš„å†³ç­–"
                        );
                        
                        if (shouldResume === "yes") {
                            try {
                                const response = await fetch(`${API_BASE_URL}/api/v1/tasks/${taskId}/resume`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ response: "yes" })
                                });
                                if (!response.ok) throw new Error('æ¢å¤ä»»åŠ¡å¤±è´¥');
                                addLog('[ä¸­æ–­] ç”¨æˆ·é€‰æ‹©ç»§ç»­', type);
                            } catch (error) {
                                addLog(`[é”™è¯¯] ${error.message}`, 'error');
                            }
                        } else {
                            addLog('[ä¸­æ–­] ç”¨æˆ·é€‰æ‹©å–æ¶ˆ', type);
                            eventSource.close();
                        }
                        break;
                    
                    case 'task_complete':
                        addLog('[å®Œæˆ] ä»»åŠ¡æˆåŠŸç»“æŸ!', type);
                        eventSource.close();
                        break;
                    
                    case 'task_failed':
                        addLog(`[å¤±è´¥] ${innerData.error}`, 'error');
                        eventSource.close();
                        break;

                    case 'connected':
                    case 'debug':
                    case 'heartbeat':
                        // å¿½ç•¥è¿™äº›ç³»ç»Ÿäº‹ä»¶
                        break;

                    default:
                        // è°ƒè¯•ï¼šæ˜¾ç¤ºæœªçŸ¥äº‹ä»¶ç±»å‹
                        console.log('æœªçŸ¥äº‹ä»¶ç±»å‹:', type, innerData);
                        addLog(`[è°ƒè¯•] æœªçŸ¥äº‹ä»¶: ${type}`, 'debug');
                        break;
                }
            };

            eventSource.onerror = (err) => {
                addLog('äº‹ä»¶æµè¿æ¥é”™è¯¯', 'error');
                eventSource.close();
            };
        }

        // è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
            logStream.innerHTML = '';
            resultDiv.textContent = '';
            
            // å¦‚æœå­˜åœ¨ä¹‹å‰çš„äº‹ä»¶æµï¼Œå…³é—­å®ƒ
            if (eventSource) {
                eventSource.close();
            }

            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.textContent = 'æ­£åœ¨åˆ›å»ºä»»åŠ¡...';

            try {
                const formData = new FormData(form);
                const data = {
                    user_id: `user_${Date.now()}`,
                    topic: formData.get('topic'),
                    max_words: parseInt(formData.get('max_words'), 10),
                    style: formData.get('style'),
                    language: formData.get('language'),
                    mode: "interactive" // ä½¿ç”¨äº¤äº’æ¨¡å¼ï¼Œå…è®¸ä¸­æ–­
                };

                const response = await fetch(`${API_BASE_URL}/api/v1/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${response.statusText}`);
                }

                const result = await response.json();
                addLog(`ä»»åŠ¡åˆ›å»ºæˆåŠŸ (ID: ${result.task_id})`, 'success');
                listenToEvents(result.task_id);

            } catch (error) {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = 'å¼€å§‹åˆ›ä½œ';
            }
        });
    });
    </script>
</body>
</html>