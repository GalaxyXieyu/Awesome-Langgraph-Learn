<!DOCTYPE html>
<html>
<head>
    <title>WebSocketæµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        .message { margin: 5px 0; padding: 8px; background: white; border-radius: 3px; border-left: 3px solid #007bff; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .connected { color: green; font-weight: bold; }
        .disconnected { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ WebSocketè°ƒè¯•æµ‹è¯•é¡µé¢</h1>
        
        <div class="section">
            <h3>ğŸ¯ åˆ›å»ºä»»åŠ¡</h3>
            <input type="text" id="topic" placeholder="æ–‡ç« ä¸»é¢˜" value="WebSocketè°ƒè¯•æµ‹è¯•">
            <button onclick="createTask()">åˆ›å»ºä»»åŠ¡</button>
            <div id="taskInfo"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ”— WebSocketè¿æ¥</h3>
            <div>è¿æ¥çŠ¶æ€: <span id="connectionStatus" class="disconnected">æœªè¿æ¥</span></div>
            <button onclick="connectWebSocket()">è¿æ¥WebSocket</button>
            <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
        </div>
        
        <div class="section">
            <h3>ğŸ“¨ å®æ—¶æ¶ˆæ¯</h3>
            <div id="messages" class="messages"></div>
            <button onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
        </div>
        
        <div class="section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentTaskId = null;
        let messageCount = 0;
        
        function log(message) {
            console.log(message);
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
        }
        
        async function createTask() {
            const topic = document.getElementById('topic').value;
            log(`ğŸ“ åˆ›å»ºä»»åŠ¡: ${topic}`);
            
            try {
                const response = await fetch('http://localhost:8003/api/v1/tasks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: 'debug_test_' + Date.now(),
                        topic: topic,
                        max_words: 400,
                        style: 'casual',
                        language: 'zh',
                        mode: 'copilot'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentTaskId = result.task_id;
                    
                    document.getElementById('taskInfo').innerHTML = `
                        <p>âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${currentTaskId}</p>
                        <p>ğŸ“Š çŠ¶æ€: ${result.status}</p>
                    `;
                    
                    log(`âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${currentTaskId}`);
                    
                    // è‡ªåŠ¨è¿æ¥WebSocket
                    setTimeout(connectWebSocket, 1000);
                } else {
                    const error = await response.text();
                    log(`âŒ ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${response.status} - ${error}`);
                }
            } catch (e) {
                log(`âŒ ä»»åŠ¡åˆ›å»ºå¼‚å¸¸: ${e.message}`);
            }
        }
        
        function connectWebSocket() {
            if (!currentTaskId) {
                log('âš ï¸ è¯·å…ˆåˆ›å»ºä»»åŠ¡');
                return;
            }
            
            if (ws) {
                ws.close();
            }
            
            const wsUrl = `ws://localhost:8003/ws/${currentTaskId}`;
            log(`ğŸ”— è¿æ¥WebSocket: ${wsUrl}`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('connectionStatus').className = 'connected';
                log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                addMessage('ğŸ”— WebSocketè¿æ¥æˆåŠŸ');
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ #${messageCount}: ${event.data.substring(0, 100)}...`);
                
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    log(`âŒ è§£ææ¶ˆæ¯å¤±è´¥: ${e.message}`);
                    addMessage(`âŒ è§£æå¤±è´¥: ${event.data}`);
                }
            };
            
            ws.onclose = function(event) {
                document.getElementById('connectionStatus').textContent = 'å·²æ–­å¼€';
                document.getElementById('connectionStatus').className = 'disconnected';
                log(`âŒ WebSocketè¿æ¥æ–­å¼€: code=${event.code}, reason=${event.reason}`);
                addMessage('âŒ WebSocketè¿æ¥æ–­å¼€');
            };
            
            ws.onerror = function(error) {
                log(`âŒ WebSocketé”™è¯¯: ${error}`);
                addMessage(`âŒ WebSocketé”™è¯¯: ${error}`);
            };
        }
        
        function handleMessage(data) {
            const msgType = data.type || 'unknown';
            
            if (msgType === 'connected') {
                addMessage(`ğŸ”— è¿æ¥ç¡®è®¤: ${data.task_id}`);
            } else if (msgType === 'task_started') {
                addMessage(`ğŸš€ ä»»åŠ¡å¼€å§‹: ${data.message}`);
            } else if (msgType === 'progress_update') {
                const step = data.step_name || data.step || 'unknown';
                const progress = data.progress || 0;
                const contentInfo = data.content_info || {};
                
                let msg = `ğŸ“‹ æ­¥éª¤: ${step} (${progress}%)`;
                if (contentInfo.content_preview) {
                    msg += `\\nğŸ’¬ ${contentInfo.content_preview.substring(0, 100)}...`;
                }
                addMessage(msg);
            } else if (msgType === 'task_complete') {
                const result = data.result || {};
                const article = result.article || '';
                const outline = result.outline || {};
                
                let msg = `ğŸ‰ ä»»åŠ¡å®Œæˆ!\\nğŸ“– æ–‡ç« é•¿åº¦: ${article.length} å­—ç¬¦\\nğŸ“ æ ‡é¢˜: ${outline.title || 'N/A'}`;
                if (data.message) {
                    msg += `\\nğŸ’¬ ${data.message}`;
                }
                addMessage(msg);
            } else if (msgType === 'pong') {
                addMessage('ğŸ’“ å¿ƒè·³å“åº”');
            } else {
                addMessage(`ğŸ“¨ ${msgType}: ${JSON.stringify(data).substring(0, 200)}...`);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br><pre style="white-space: pre-wrap;">${message}</pre>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            messageCount = 0;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
        };
        
        // å®šæœŸå‘é€å¿ƒè·³
        setInterval(function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('ping');
            }
        }, 10000);
    </script>
</body>
</html>
